# Authentication

Below is a brief overview of Monocle's JWT-based authentication.

## State
The authentication methods of the GraphQL API set tokens as `HttpOnly` cookies on the client, meaning that they cannot be read by the application's JavaScript. There are two types of cookie:
* a short-lived `authToken`, needed for private API requests
* a long-lived `refreshToken`, needed to refresh the `authToken` without resubmitting login credentials

The various cookie states that the client can be in are outlined in the following diagram. They have colour codes to clarify their meaning.

[![](https://mermaid.ink/img/eyJjb2RlIjoic3RhdGVEaWFncmFtXG4gICAgc3RhdGUgXCJSZWQgKG5vIGFjY2VzcylcIiBhcyByZWQ6YXV0aFRva2VuPWZhbHNlLHJlZnJlc2hUb2tlbj1mYWxzZVxuICAgIHN0YXRlIFwiR3JlZW4gKGZ1bGwgYWNjZXNzKVwiIGFzIGdyZWVuOmF1dGhUb2tlbj10cnVlLHJlZnJlc2hUb2tlbj10cnVlXG4gICAgc3RhdGUgXCJBbWJlciAoYWNjZXNzIHRvIEFQSSdzIHJlZnJlc2ggbWV0aG9kKVwiIGFzIGFtYmVyOmF1dGhUb2tlbj1mYWxzZSxyZWZyZXNoVG9rZW49dHJ1ZVxuICAgIFxuXHRbKl0gLS0-IHJlZFxuICAgIHJlZCAtLT4gZ3JlZW46IGxvZ2luXG4gICAgZ3JlZW4gLS0-IHJlZDogbG9nb3V0XG4gICAgZ3JlZW4gLS0-IGFtYmVyOiBhY2Nlc3MgdG9rZW4gZXhwaXJ5XG4gICAgYW1iZXIgLS0-IGdyZWVuOiByZWZyZXNoKClcbiAgICBhbWJlciAtLT4gcmVkOiByZWZyZXNoIHRva2VuIGV4cGlyeVxuIiwibWVybWFpZCI6eyJ0aGVtZSI6ImRlZmF1bHQifSwidXBkYXRlRWRpdG9yIjpmYWxzZX0)](https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoic3RhdGVEaWFncmFtXG4gICAgc3RhdGUgXCJSZWQgKG5vIGFjY2VzcylcIiBhcyByZWQ6YXV0aFRva2VuPWZhbHNlLHJlZnJlc2hUb2tlbj1mYWxzZVxuICAgIHN0YXRlIFwiR3JlZW4gKGZ1bGwgYWNjZXNzKVwiIGFzIGdyZWVuOmF1dGhUb2tlbj10cnVlLHJlZnJlc2hUb2tlbj10cnVlXG4gICAgc3RhdGUgXCJBbWJlciAoYWNjZXNzIHRvIEFQSSdzIHJlZnJlc2ggbWV0aG9kKVwiIGFzIGFtYmVyOmF1dGhUb2tlbj1mYWxzZSxyZWZyZXNoVG9rZW49dHJ1ZVxuICAgIFxuXHRbKl0gLS0-IHJlZFxuICAgIHJlZCAtLT4gZ3JlZW46IGxvZ2luXG4gICAgZ3JlZW4gLS0-IHJlZDogbG9nb3V0XG4gICAgZ3JlZW4gLS0-IGFtYmVyOiBhY2Nlc3MgdG9rZW4gZXhwaXJ5XG4gICAgYW1iZXIgLS0-IGdyZWVuOiByZWZyZXNoKClcbiAgICBhbWJlciAtLT4gcmVkOiByZWZyZXNoIHRva2VuIGV4cGlyeVxuIiwibWVybWFpZCI6eyJ0aGVtZSI6ImRlZmF1bHQifSwidXBkYXRlRWRpdG9yIjpmYWxzZX0)

Ideally, being in the amber state should be transient and transparent to the user. An outline of how user actions map to the green (logged in) and red (fully logged out) states is described below.

[![](https://mermaid.ink/img/eyJjb2RlIjoiZ3JhcGggVEJcbiAgICBsb2dnZWRJbltbbG9nZ2VkSW5dXVxuICAgIGxvZ2dlZE91dFtbbG9nZ2VkT3V0XV1cblx0b25Mb2FkKFtvblBhZ2VMb2FkXSlcbiAgICBvblJlZnJlc2goW29uUGFnZVJlZnJlc2hdKVxuICAgIG9uUHJpdmF0ZVtwcml2YXRlUmVxdWVzdF1cbiAgICBsb2dpbltsb2dpbl1cbiAgICBsb2dvdXRbbG9nb3V0XVxuICAgIHZlcmlmeVt2ZXJpZnlBdXRoVG9rZW5dXG4gICAgcmVmcmVzaFtyZWZyZXNoQXV0aFRva2VuXVxuXG4gICAgXG4gICAgdmVyaWZ5IC0tPnxlcnJvcjogYXV0aCB0b2tlbiBleHBpcmVkfCByZWZyZXNoXG4gICAgb25Mb2FkIC0tPiB2ZXJpZnlcbiAgICB2ZXJpZnkgLS0-fHN1Y2Nlc3N8IGxvZ2dlZEluXG4gICAgcmVmcmVzaCAtLT58c3VjY2VzczogbmV3IGF1dGggdG9rZW58IGxvZ2dlZEluXG4gICAgcmVmcmVzaCAtLT58ZXJyb3I6IHJlZnJlc2ggdG9rZW4gZXhwaXJlZHwgbG9nZ2VkT3V0XG4gICAgbG9nZ2VkSW4gLS0-IG9uUmVmcmVzaFxuICAgIG9uUmVmcmVzaCAtLT4gdmVyaWZ5XG4gICAgbG9nZ2VkSW4gLS0-IG9uUHJpdmF0ZVxuICAgIG9uUHJpdmF0ZSAtLT58c3VjY2Vzc3wgbG9nZ2VkSW5cbiAgICBvblByaXZhdGUgLS0-fGVycm9yOiBubyB0b2tlbiBvciBhdXRoL3JlZnJlc2ggdG9rZW4gZXhwaXJlZHwgdmVyaWZ5XG4gICAgbG9nZ2VkSW4gLS0-IGxvZ291dFxuICAgIGxvZ291dCAtLT58dG9rZW5zIGRlbGV0ZWR8IGxvZ2dlZE91dFxuICAgIGxvZ2dlZE91dCAtLT4gbG9naW5cbiAgICBsb2dpbiAtLT58ZXJyb3I6IGJhZCBjcmVkZW50aWFsc3wgbG9nZ2VkT3V0XG4gICAgbG9naW4gLS0-fHN1Y2Nlc3M6IG5ldyBhdXRoIHRva2VuLCByZWZyZXNoIHRva2VufCBsb2dnZWRJblxuICAgIFxuIiwibWVybWFpZCI6eyJ0aGVtZSI6ImRlZmF1bHQifSwidXBkYXRlRWRpdG9yIjpmYWxzZX0)](https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoiZ3JhcGggVEJcbiAgICBsb2dnZWRJbltbbG9nZ2VkSW5dXVxuICAgIGxvZ2dlZE91dFtbbG9nZ2VkT3V0XV1cblx0b25Mb2FkKFtvblBhZ2VMb2FkXSlcbiAgICBvblJlZnJlc2goW29uUGFnZVJlZnJlc2hdKVxuICAgIG9uUHJpdmF0ZVtwcml2YXRlUmVxdWVzdF1cbiAgICBsb2dpbltsb2dpbl1cbiAgICBsb2dvdXRbbG9nb3V0XVxuICAgIHZlcmlmeVt2ZXJpZnlBdXRoVG9rZW5dXG4gICAgcmVmcmVzaFtyZWZyZXNoQXV0aFRva2VuXVxuXG4gICAgXG4gICAgdmVyaWZ5IC0tPnxlcnJvcjogYXV0aCB0b2tlbiBleHBpcmVkfCByZWZyZXNoXG4gICAgb25Mb2FkIC0tPiB2ZXJpZnlcbiAgICB2ZXJpZnkgLS0-fHN1Y2Nlc3N8IGxvZ2dlZEluXG4gICAgcmVmcmVzaCAtLT58c3VjY2VzczogbmV3IGF1dGggdG9rZW58IGxvZ2dlZEluXG4gICAgcmVmcmVzaCAtLT58ZXJyb3I6IHJlZnJlc2ggdG9rZW4gZXhwaXJlZHwgbG9nZ2VkT3V0XG4gICAgbG9nZ2VkSW4gLS0-IG9uUmVmcmVzaFxuICAgIG9uUmVmcmVzaCAtLT4gdmVyaWZ5XG4gICAgbG9nZ2VkSW4gLS0-IG9uUHJpdmF0ZVxuICAgIG9uUHJpdmF0ZSAtLT58c3VjY2Vzc3wgbG9nZ2VkSW5cbiAgICBvblByaXZhdGUgLS0-fGVycm9yOiBubyB0b2tlbiBvciBhdXRoL3JlZnJlc2ggdG9rZW4gZXhwaXJlZHwgdmVyaWZ5XG4gICAgbG9nZ2VkSW4gLS0-IGxvZ291dFxuICAgIGxvZ291dCAtLT58dG9rZW5zIGRlbGV0ZWR8IGxvZ2dlZE91dFxuICAgIGxvZ2dlZE91dCAtLT4gbG9naW5cbiAgICBsb2dpbiAtLT58ZXJyb3I6IGJhZCBjcmVkZW50aWFsc3wgbG9nZ2VkT3V0XG4gICAgbG9naW4gLS0-fHN1Y2Nlc3M6IG5ldyBhdXRoIHRva2VuLCByZWZyZXNoIHRva2VufCBsb2dnZWRJblxuICAgIFxuIiwibWVybWFpZCI6eyJ0aGVtZSI6ImRlZmF1bHQifSwidXBkYXRlRWRpdG9yIjpmYWxzZX0)

The main application code is aware of only a boolean `isLoggedIn` value and `login`, `logout` methods, available through a React context, via the `AuthProvider` and `useAuth`.

Additionally, there is some logic to handle failed private requests and retry them, using `apollo-link-error`.

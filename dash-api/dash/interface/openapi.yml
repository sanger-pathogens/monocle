openapi: '3.0.0'
info:
  title: "Monocle Dashboard API"
  version: "0.0.1"
  description: "A REST API service used by the Monocle dashboard."
  contact:
    email: "path-help@sanger.ac.uk"

servers:
  - url: /dashboard-api
    description: Context path

paths:
  /set_auth_cookie:
    post:
      operationId: dash.api.routes.set_auth_cookie_route
      summary: "Sets an authentication cookie and redirects user to page they were attempting to access. Credentials are NOT VERIFIED by this endpoint: this cookie needs to be checked by NGINX before authorisation is granted."
      parameters:
        - name: X-Target
          in: header
          description: "URL the user was requesting when intercepted for authorisation."
          required: false
          schema:
            type: string
            format: uri
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  description: "The username provided by the user"
                  type: string
                  minLength: 3
                  maxLength: 256
                password:
                  description: "The password provided by the user"
                  type: string
                  minLength: 3
                  maxLength: 256
      responses:
        "307":
          description: "The operation was successful. An UNVERIFIED authentication cookie is set and the user is redirected."
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    readOnly: true
                    type: string
                    
  /delete_auth_cookie:
    get:
      operationId: dash.api.routes.delete_auth_cookie_route
      summary: "Immediately expires the authentication token used by NGINX."
      parameters:
        - name: X-Target
          in: header
          description: "URL the user should be redirected to after the cookies is deleted."
          required: false
          schema:
            type: string
            format: uri
      responses:
        "307":
          description: "The operation was successful. The authentication cookie has is expired and the user is redirected."
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    readOnly: true
                    type: string

  /get_user_details:
    get:
      operationId: dash.api.routes.get_user_details_route
      summary: "Return all details for a user"
      parameters:
        - name: X-Remote-User
          in: header
          description: "Username."
          required: false
          schema:
            $ref: "#/components/schemas/UserName"
      responses:
        "200":
          description: "The operation was successful. A user details record is returned."
          content:
            application/json:
              schema:
                type: object
                properties:
                  user_details:
                    $ref: "#/components/schemas/UserData"
        "403":
          description: "Authorization information is missing or invalid."

  /get_batches:
    get:
      operationId: dash.api.routes.get_batches_route
      summary: "Return information on batches delivered, keyed by institution id."
      parameters:
        - name: X-Remote-User
          in: header
          description: "Username."
          required: false
          schema:
            $ref: "#/components/schemas/UserName"
      responses:
        "200":
          description: "The operation was successful. Returned data will be keyed on institution id, shown as additionalProp in the example below..."
          content:
            application/json:
              schema:
                type: object
                properties:
                  batches:
                    type: object
                    additionalProperties:
                      $ref: "#/components/schemas/InstitutionBatchSummary"
        "403":
          description: "Authorization information is missing or invalid."

  /sequencing_status_summary:
    get:
      operationId: dash.api.routes.sequencing_status_summary_route
      summary: "Return information on sample/lane sequencing status, keyed by institution id."
      parameters:
        - name: X-Remote-User
          in: header
          description: "Username."
          required: false
          schema:
            $ref: "#/components/schemas/UserName"
      responses:
        "200":
          description: "The operation was successful. Returned data will be keyed on institution id, shown as additionalProp in the example below..."
          content:
            application/json:
              schema:
                type: object
                properties:
                  sequencing_status:
                    type: object
                    additionalProperties:
                      $ref: "#/components/schemas/InstitutionSequencingStatus"
        "403":
          description: "Authorization information is missing or invalid."

  /project:
    get:
      operationId: dash.api.routes.project_route
      summary: "Returns information used in the UI, like the logo URL."
      responses:
        "200":
          description: "The operation was successful."
          content:
            application/json:
              schema:
                type: object
                properties:
                  project:
                    type: object
        "403":
          description: "Authorization information is missing or invalid."

  /pipeline_status_summary:
    get:
      operationId: dash.api.routes.pipeline_status_summary_route
      summary: "Return information on sample/lane pipeline status, keyed by institution id."
      parameters:
        - name: X-Remote-User
          in: header
          description: "Username."
          required: false
          schema:
            $ref: "#/components/schemas/UserName"
      responses:
        "200":
          description: "The operation was successful. Returned data will be keyed on institution id, shown as additionalProp in the example below..."
          content:
            application/json:
              schema:
                type: object
                properties:
                  sequencing_status:
                    type: object
                    additionalProperties:
                      $ref: "#/components/schemas/InstitutionPipelineStatus"
        "403":
          description: "Authorization information is missing or invalid."
          
  /get_field_attributes:
    get:
      operationId: dash.api.routes.get_field_attributes_route
      summary: "Return attrubutes of metadata, in silico and QC data fields."
      parameters:
        - name: X-Remote-User
          in: header
          description: "Username."
          required: false
          schema:
            $ref: "#/components/schemas/UserName"
      responses:
        "200":
          description: "The operation was successful. Returned data is a JSON obnject describing metadata, in silico and QC data fields."
          content:
            application/json:
              schema:
                type: object
                properties:
                  field_attributes:
                    type: object
                    $ref: "#/components/schemas/FieldAttributes"
        "403":
          description: "Authorization information is missing or invalid."

  /bulk_download_info:
    post:
      operationId: dash.api.routes.bulk_download_info_route
      summary: "Return information on expected bulk download based on standard sample filters and data types"
      parameters:
        - name: X-Remote-User
          in: header
          description: "Username."
          required: false
          schema:
            $ref: "#/components/schemas/UserName"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BulkDownloadInput"
      responses:
        "200":
          description: "The operation was successful. The following data format will be returned..."
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DownloadInfo"
        "403":
          description: "Authorization information is missing or invalid."
        "404":
          description: "No samples were found that matched the request criteria."

  /bulk_download_urls:
    post:
      operationId: dash.api.routes.bulk_download_urls_route
      summary: "Return download links corresponding to standard sample filters and data types"
      parameters:
        - name: X-Remote-User
          in: header
          description: "Username."
          required: false
          schema:
            $ref: "#/components/schemas/UserName"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BulkDownloadInput"
      responses:
        "200":
          description: "The operation was successful. The following data format will be returned..."
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DownloadURLs"
        "403":
          description: "Authorization information is missing or invalid."
        "404":
          description: "No samples were found that matched the request criteria."

  /data_download/{token}:
    get:
      operationId: dash.api.routes.data_download_route
      summary: "For data download (assembly/annotation/reads in ZIP archive).  Response is a 302 redirecting to static file route for the download."
      parameters:
        - in: header
          name: X-Remote-User
          description: "Username."
          required: false
          schema:
            $ref: "#/components/schemas/UserName"
        - name: "token"
          in: path
          description: "Download token (generated and embeded in URL(s) by /bulk_download_urls)"
          required: true
          schema:
            type: string
            minLength: 16
            maxLength: 32
            pattern: ^[a-f0-9]+$
        - name: "redirect"
          in: query
          description: "Flag indicating if the resposne should be a 303 redirect to the download location.  Test in swagger with \"false\", otherwise swagger UI will follow the redirect in the response and download the ZIP archive."
          required: false
          schema:
            type: boolean
            default: true
            example: false
      responses:
        "200":
          description: "The operation was successful. Return data provides the download location."
          content:
            application/json:
              schema:
                type: object
                properties:
                  download location:
                    type: string
                    format: uri
        "303":
          description: "The data are available."
          headers:
            Location:
              description: ""
              schema:
                type: string
                format: uri
        "403":
          description: "Download token missing or invalid."
        "404":
          description: "The data are not available (bad or expired token)."
          
  /get_progress:
    get:
      operationId: dash.api.routes.get_progress_route
      summary: "Return the information necessary for plotting the project sample progress graph."
      parameters:
        - name: X-Remote-User
          in: header
          description: "Username."
          required: false
          schema:
            $ref: "#/components/schemas/UserName"
      responses:
        "200":
          description: "The operation was successful. The following data format will be returned..."
          content:
            application/json:
              schema:
                type: object
                properties:
                  progress_graph:
                    $ref: "#/components/schemas/ProjectProgress"
        "403":
          description: "Authorization information is missing or invalid."

  /get_institutions:
    get:
      operationId: dash.api.routes.get_institutions_route
      summary: "Return a list of institutions."
      parameters:
        - name: X-Remote-User
          in: header
          description: "Username."
          required: false
          schema:
            $ref: "#/components/schemas/UserName"
      responses:
        "200":
          description: "The operation was successful. Returned data will be keyed on institution id, shown as additionalProp in the example below..."
          content:
            application/json:
              schema:
                type: object
                properties:
                  institutions:
                    type: object
                    additionalProperties:
                      $ref: "#/components/schemas/Institution"
        "403":
          description: "Authorization information is missing or invalid."

  /get_metadata:
    post:
      operationId: dash.api.routes.get_metadata_route
      summary: "Return metadata for samples matching standard sample filters"
      parameters:
        - name: X-Remote-User
          in: header
          description: "Username."
          required: false
          schema:
            $ref: "#/components/schemas/UserName"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GetMetadataInput"
      responses:
        "200":
          description: "The operation was successful. The following data format will be returned..."
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetMetadataOutput"
            text/csv:
              schema:
                type: string
        "403":
          description: "Authorization information is missing or invalid."
        "404":
          description: "No samples were found that matched the request criteria."
 
  /get_distinct_values:
    post:
      operationId: dash.api.routes.get_distinct_values_route
      summary: "Return distinct values found in metadata, in silico or QC data fields"
      parameters:
        - name: X-Remote-User
          in: header
          description: "Username."
          required: false
          schema:
            $ref: "#/components/schemas/UserName"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GetDistinctValuesInput"
            example:
              { "fields":
                  [  {  "field type":    "metadata",
                        "field names":   ["serotype", "age_group"]
                        },
                     {  "field type":    "in silico",
                        "field names":   ["ST", "cps_type"]
                        }
                     ],
                "sample filters":
                  {  "batches": [
                        {
                        "institution key": "MinHeaCenLab",
                        "batch date": "2019-11-15"
                        }
                     ],
                     "metadata": {
                        "age_group": [
                        "adult"
                        ]
                     },
                     "in silico": {
                        "ST": [
                        "1",
                        "12",
                        "14"
                        ]
                     }
                  }
                }
                
      responses:
        "200":
          description: "The operation was successful."
          content:
            application/json:
              schema:
                type: object
                properties:
                  distinct values:
                    $ref: "#/components/schemas/GetDistinctValuesOutput"
              example:
                { "distinct values": [
                     {  "field type": "metadata",
                        "fields":     [   {  "name":     "serotype",
                                             "values":   ["Ia", "Ib", "III"],
                                             "matches":  [  {"value": "Ia",  "number": 0 },
                                                            {"value": "Ib",  "number": 7 },
                                                            {"value": "III", "number": 4 }
                                                            ]

                                             },
                                          {  "name":     "age_group",
                                             "values":   ["adult", "adolescent", "infant"],
                                             "matches":  [  {"value": "adult",      "number": 15 },
                                                            {"value": "adolescent", "number": 7 },
                                                            {"value": "infant",     "number": 0 }
                                                            ]
                                             }
                                       ]
                        },
                     {  "field type": "in silico",
                        "fields":      [  {  "name": "ST",
                                             "values": ["1", "1*", "10", "103", "103*?"],
                                             "matches":  [  {"value": "1",     "number": 4 },
                                                            {"value": "1*",    "number": 3 },
                                                            {"value": "103",   "number": 0 },
                                                            {"value": "103*?", "number": 0 }
                                                            ]
                                             },
                                          {  "name": "cps_type",
                                             "values": ["II", "III", "III/V", "Ia/II"],
                                             "matches":  [  {"value": "II",    "number": 4 },
                                                            {"value": "III",   "number": 3 },
                                                            {"value": "III/V", "number": 11 },
                                                            {"value": "Ia/II", "number": 6 }
                                                            ]
                                             }
                                          ]
                        }
                  ]}
                                
                    
        "403":
          description: "Authorization information is missing or invalid."
        "404":
          description: "One or more of the requested fields not recognised."
 
  /get_metadata_for_download/{institution}/{category}/{status}:
    get:
      operationId: dash.api.routes.get_metadata_for_download_route
      summary: "The operation was successful. The following data format will be returned..."
      parameters:
        - in: header
          name: X-Remote-User
          description: "Username."
          required: false
          schema:
            $ref: "#/components/schemas/UserName"
        - name: "institution"
          in: path
          description: "The institution name."
          required: true
          schema:
            $ref: "#/components/schemas/InstitutionName"
        - name: "category"
          in: path
          description: "The category to be downloaded: sequencing or pipeline."
          required: true
          schema:
            $ref: "#/components/schemas/DashboardMetadataDownloadCategory"
        - name: "status"
          in: path
          description: "The status type to be downloaded: successful or failed."
          required: true
          schema:
            $ref: "#/components/schemas/DashboardMetadataDownloadStatus"
      responses:
        "200":
          description: "The operation was successful."
          content:
            text/csv:
              schema:
                type: string
        "403":
          description: "Authorization information is missing or invalid."

components:
  schemas:

    UserName:
       type: string
       minLength: 3
       maxLength: 256
       pattern: ^[a-zA-Z0-9à-úÀ-Ú\!#\$%&'\*\+\-\./=\?\^_`\{\|\}~;]+$

    Institution:
      description: "Institution key, name and source countries."
      type: object
      required:
        - db_key
        - inst_name
        - country_names
      properties:
        db_key:
          $ref: "#/components/schemas/InstitutionID"
        inst_name:
          $ref: "#/components/schemas/InstitutionName"
        country_names:
          $ref: "#/components/schemas/CountryNames"

    CountryNames:
      description: "List of countries."
      type: array
      items:
        $ref: "#/components/schemas/CountryName"
      minItems: 1

    InstitutionID:
       description: "The ID of the institution."
       type: string
       minLength: 3
       maxLength: 256
       pattern: ^[a-zA-Z0-9à-úÀ-Ú]*$
       example: "MinHeaCenLab"

    InstitutionName:
       description: "The name of the institution."
       type: string
       minLength: 3
       maxLength: 256
       pattern: ^[a-zA-Z0-9à-úÀ-Ú _\-',;:\.\(\)]*$
       example: "Ministry of Health, Central Laboratories"

    CountryName:
      type: string
      minLength: 3
      maxLength: 256
      pattern: ^[a-zA-Z0-9à-úÀ-Ú _\-',;:\.\(\)\[\]]*$

    DashboardMetadataDownloadCategory:
       type: string
       minLength: 1
       maxLength: 20
       pattern: ^sequencing|pipeline$
       
    DashboardMetadataDownloadStatus:
       type: string
       minLength: 1
       maxLength: 20
       pattern: ^successful|failed$

    SampleFilters:
      type: object
      required:
        - batches
      properties:
        batches:
          type: array
          items:
            $ref: "#/components/schemas/InstKeyBatchDatePair"
        sequencing:
          $ref: "#/components/schemas/SequencingFilters"
        pipeline:
          $ref: "#/components/schemas/PipelineFilters"
        metadata:
          $ref: "#/components/schemas/MetadataFilters"
        in silico:
          $ref: "#/components/schemas/InSilicoFilters"

    SequencingFilters:
      type: object
      properties:
        complete:
          description: "samples with at least one lane that has completed sequencing, whether or not sequencing was a success"
          type: boolean
          default: false
        success:
          description: "samples with at least one lane that has been successfully sequenced"
          type: boolean
          default: false
      example:
        success: true

    PipelineFilters:
      type: object
      properties:
        complete:
          description: "samples with at least one lane that has completed pipeline, whether or not all stages were successful"
          type: boolean
          default: false
        success:
          description: "samples with at least one lane that was successful through all pipeline stages"
          type: boolean
          default: false
      example:
        success: true

    MetadataFilters:
      type: object
      additionalProperties:
        type: array
        items:
          type: string
          nullable: true
          minLength: 1
          maxLength: 256
        minItems: 1
      minItems: 0
      example:
        age_group: ["adult"]

    InSilicoFilters:
      type: object
      additionalProperties:
        type: array
        items:
          type: string
          nullable: true
          minLength: 1
          maxLength: 256
        minItems: 1
      minItems: 0
      example:
        ST: ["1", "12", "14"]

    DataFieldType:
       description: "The type of data field:  metadata, in silico, or QC data"
       type: string
       minLength: 1
       maxLength: 20
       pattern: ^metadata|in silico|qc data$
       
    DataFieldName:
       description: "The name of a data field, in either JUNO or GPS"
       anyOf:
         - $ref: "file:///app/dash/interface/juno_objects.yml#/components/schemas/JUNOMetadataFieldName"
         - $ref: "file:///app/dash/interface/juno_objects.yml#/components/schemas/JUNOInSilicoFieldName"
         - $ref: "file:///app/dash/interface/juno_objects.yml#/components/schemas/JUNOQCDataFieldName"
         - $ref: "file:///app/dash/interface/gps_objects.yml#/components/schemas/GPSMetadataFieldName"
         - $ref: "file:///app/dash/interface/gps_objects.yml#/components/schemas/GPSInSilicoFieldName"
         - $ref: "file:///app/dash/interface/gps_objects.yml#/components/schemas/GPSQCDataFieldName"

    GetMetadataInput:
      type: object
      required:
        - sample filters
      properties:
        sample filters:
          $ref: "#/components/schemas/SampleFilters"
        as csv:
          description: "Set this flag to true when a text/csv response is required"
          type: boolean
          default: false
        csv filename:
          description: "For text/csv responses: the filename to use in the Content-Disposition header"
          type: string
          minLength: 1
          maxLength: 256
          default: "monocle.csv"
          example: "monocle.csv"
        in silico:
          description: "Set this flag to true to include in silico data with the metadata (ignored when 'as csv' is true)"
          type: boolean
          default: true
        qc data:
          description: "Set this flag to true to include in QC data with the metadata (ignored when 'as csv' is true)"
          type: boolean
          default: true
        start row:
          description: "For pagination: the first row of metadata (starting at 1) to be returned (ignored when 'as csv' is true)"
          type: integer
          minimum: 1
          example: 1
        num rows:
          description: "For pagination: number of rows of metadata to be returned (ignored when 'as csv' is true)"
          type: integer
          minimum: 1
          default: 20
          example: 20
        metadata columns:
          description: "List of metadata columns that should be returned (as defined by the Metadata object). Pass ['_ALL'] to get all columns. Ignored when 'as csv' is true: all columns are always returned."
          type: array
          items:
            type: string
            pattern: ^[a-zA-Z0-9_]*$
          default:
            - "submitting_institution"
            - "public_name"
            - "host_status"
            - "selection_random"
            - "country"
            - "collection_year"
            - "host_species"
            - "isolation_source"
            - "serotype"
          example:
            - "submitting_institution"
            - "public_name"
            - "host_status"
            - "selection_random"
            - "country"
            - "collection_year"
            - "host_species"
            - "isolation_source"
            - "serotype"
        in silico columns:
          description: "List of in silico data columns that should be returned (as defined by the InSilicoData object). Pass ['_ALL'] to get all columns. Ignored when 'as csv' is true: all columns are always returned."
          type: array
          items:
            type: string
            pattern: ^[a-zA-Z0-9_]*$
          default:
            - "ST"
          example:
            - "ST"
        qc data columns:
          description: "List of QC data columns that should be returned (as defined by the QCData object). Pass ['_ALL'] to get all columns. Ignored when 'as csv' is true: all columns are always returned."
          type: array
          items:
            type: string
            pattern: ^[a-zA-Z0-9_]*$
          default:
            - "rel_abun_sa"
          example:
            - "rel_abun_sa"

    GetMetadataOutput:
      type: object
      readOnly: true
      required:
        - samples
        - total rows
        - last row
      properties:
        last row:
          description: "Number of the last row in this response.  If start row + num rows exceeds the total number of rows, this will be the last available row."
          type: integer
          minimum: 1
        total rows:
          description: "Total number of rows that match the sample filters passed."
          type: integer
          minimum: 0
        samples:
          type: array
          items:
            $ref: "#/components/schemas/CombinedSampleMetadata"

    GetDistinctValuesInput:
      type: object
      required:
        - fields
      properties:
        fields:
          type: array
          minItems: 1
          items:
            type: object
            properties:
              field type:
                description: "The type of field"
                $ref: "#/components/schemas/DataFieldType"
              field names:
                description: "A list of fields for which distinct values are required."
                type: array
                minItems: 1
                items:
                  $ref: "#/components/schemas/DataFieldName"
        sample filters:
          $ref: "#/components/schemas/SampleFilters"
          
    GetDistinctValuesOutput:
      type: array
      readOnly: true
      items:
        type: object
        properties:
          field type:
            description: "The type of field"
            $ref: "#/components/schemas/DataFieldType"
          fields:
            description: "A list of fields for which distinct values are required."
            type: array
            items:
              type: object
              required:
                - name
                - values
              properties:
                name:
                  $ref: "#/components/schemas/DataFieldName"
                values:
                  type: array
                  items:
                    description: "A value of this field that exists in the database"
                    type: string
                matches:
                  type: array
                  items:
                    type: object
                    properties:
                      value:
                        description: "A value of this field that exists in the database"
                        type: string
                      number:
                        description: "The number of filtered samples in which this value occurs"
                        type: integer

    CombinedSampleMetadata:
      type: object
      description: "Sample manifest metadata plus in silico and QC data"
      required:
        - metadata
      properties:
        metadata:
          anyOf:
            - $ref: "file:///app/dash/interface/juno_objects.yml#/components/schemas/JUNOMetadata"
            - $ref: "file:///app/dash/interface/gps_objects.yml#/components/schemas/GPSMetadata"
        in silico:
          anyOf:
            - $ref: "file:///app/dash/interface/juno_objects.yml#/components/schemas/JUNOInSilicoData"
            - $ref: "file:///app/dash/interface/gps_objects.yml#/components/schemas/GPSInSilicoData"
        qc data:
          anyOf:
            - $ref: "file:///app/dash/interface/juno_objects.yml#/components/schemas/JUNOQCData"
            - $ref: "file:///app/dash/interface/gps_objects.yml#/components/schemas/GPSQCData"

    FieldAttributes:
      type: object
      readOnly: true
      properties:
        metadata:
          type: object
          properties:
            categories:
              type: array
              items:
                $ref: "#/components/schemas/FieldCategory"
        in silico:
          type: object
          properties:
            categories:
              type: array
              items:
                $ref: "#/components/schemas/FieldCategory"
        qc data:
          type: object
          properties:
            categories:
              type: array
              items:
                $ref: "#/components/schemas/FieldCategory"
          
    FieldCategory:
      description: "A category of fields, grouped together as they describe conceptually related values."
      type: object
      readOnly: true
      properties:
        name:
          description: "The name of the category."
          type: string
        fields:
          description: "A list of fields in the category."
          type: array
          items:
            $ref: "#/components/schemas/FieldDescription"
        
    FieldDescription:
      description: "A description of a field"
      type: object
      readOnly: true
      required:
        - name
        - display
        - order
        - spreadsheet heading
        - display name
        - filter type
      properties:
        name:
          description: "The name of the field"
        display:
          description: "Flag indicating if this field should be displayed"
          type: boolean
        order:
          description: "Sort order for this field (1 = first column, etc.) in spreadsheet format.  Note that this format ignores the field categories!"
          type: integer
          minimum: 1
        spreadsheet heading:
          description: "The heading for this field in spreadsheet format"
          type: string
          minLength: 2
          maxLength: 256
        display name:
          description: "The name of this field that should be used for display"
          type: string
          minLength: 2
          maxLength: 256
        filter type:
          description: "The type of filter that should be used with this field: \"discrete\", \"numeric\", or \"none\""
          type: string
          pattern: ^discrete|numeric|none$
    
    DownloadField:
      type: object
      required:
        - "title"
        - "value"
        - "order"
      properties:
        order:
          type: integer
          description: "An ordering integer index for the field"
          readOnly: true
        title:
          type: string
          description: "The name of the metadata field"
          readOnly: true
        value:
          type: string
          description: "The value of the metadata field"
          readOnly: true

    BulkDownloadInput:
      type: object
      required:
        - sample filters
      properties:
        sample filters:
          $ref: "#/components/schemas/SampleFilters"
        assemblies:
          type: boolean
        annotations:
          type: boolean
        reads:
          type: boolean
        max samples per zip:
          description: "The maximum number of samples in each ZIP archive.  Automatically divided by 10 if reads is true."
          type:    integer
          minimum: 1
          maximum: 500
          example: 25

    InstKeyBatchDatePair:
      type: object
      required:
        - "institution key"
        - "batch date"
      description: "Batch of samples, identified by institution and delivery date"
      properties:
        institution key:
          description: "Institution ID"
          $ref: "#/components/schemas/InstitutionID"
        batch date:
          description: "Date of delivery"
          $ref: "#/components/schemas/BatchDate"

    BatchDate:
      type: string
      format: date
      example: "2019-11-15"

    DownloadInfo:
      type: object
      required:
        - num_samples
        - size
        - size_zipped
        - size_per_zip_options
      properties:
        num_samples:
          type: integer
          readOnly: true
        size:
          type: string
          readOnly: true
        size_zipped:
          type: string
          readOnly: true
        size_per_zip_options:
          type: array
          items:
            type: object
            required:
              - max_samples_per_zip
              - size_per_zip
            properties:
              max_samples_per_zip:
                type: integer
                minimum: 0
              size_per_zip:
                type: string
                minLength: 1
          readOnly: true

    DownloadURLs:
      type: object
      required:
        - download_urls
      properties:
        download_urls:
          type: array
          items:
            type: string
            format: uri

    ProjectProgress:
      type: object
      required:
        - data
      properties:
        data:
          $ref: "#/components/schemas/ProjectProgressData"

    ProjectProgressData:
      type: object
      required:
        - "date"
        - "samples received"
        - "samples sequenced"
      description: "Progress graph data."
      properties:
        date:
          type: array
          items:
            description: "The batch date."
            example: "Jan 2019"
            type: string
            readOnly: true
        samples received:
          type: array
          items:
            description: "The number of samples received for the batch."
            example: 300
            type: string
            readOnly: true
        samples sequenced:
          type: array
          items:
            description: "The number of samples sequenced for the batch."
            example: 200
            type: string
            readOnly: true

    InstitutionBatchSummary:
      type: object
      required:
        - expected
        - received
        - deliveries
      description: "Sample batch information for an institution."
      properties:
        expected:
          description: "The number of samples expected."
          example: 200
          type: integer
          readOnly: true
        received:
          description: "The number of samples received."
          example: 200
          type: integer
          readOnly: true
        deliveries:
          type: array
          items:
            $ref: "#/components/schemas/Batch"
          description: "Information on all batches delivered."

    Batch:
      type: object
      required:
        - name
        - date
        - number
      description: "Sample batch information."
      properties:
        name:
          description: "The batch name."
          example: "Batch 1"
          type: string
          readOnly: true
        date:
          description: "The delivery date."
          example: "2019-09-18"
          type: string
          readOnly: true
        number:
          description: "The batch sample size."
          example: 200
          type: integer
          readOnly: true

    InstitutionSequencingStatus:
      type: object
      required:
        - received
        - completed
        - success
        - failed
        - fail_messages
      description: "Sequencing status summary information for an institution."
      properties:
        received:
          description: "The number of samples received."
          example: 400
          type: integer
          readOnly: true
        completed:
          description: "The number of samples with at least one lane that as completed sequencing, whether pass or fail."
          example: 300
          type: integer
          readOnly: true
        lanes completed:
          description: "The number of lanes that have completed sequencing, whether pass or fail."
          example: 300
          type: integer
          readOnly: true
        success:
          description: "The number of lanes that have successfully completed sequencing."
          example: 298
          type: integer
          readOnly: true
        failed:
          description: "The number of lanes that have failed sequencing."
          example: 2
          type: integer
          readOnly: true
        fail_messages:
          type: array
          items:
            $ref: "#/components/schemas/FailureInformation"
          description: "Error information on all sequencing failures."

    InstitutionPipelineStatus:
      type: object
      required:
        - running
        - completed
        - success
        - failed
        - fail_messages
      description: "Pathogen pipelines status summary information for an institution."
      properties:
        running:
          description: "The number of lanes currently running."
          example: 400
          type: integer
          readOnly: true
        completed:
          description: "The number of lanes that have completed pipelines, whether pass or fail."
          example: 300
          type: integer
          readOnly: true
        success:
          description: "The number of lanes that have successfully completed pipeline runs."
          example: 298
          type: integer
          readOnly: true
        failed:
          description: "The number of lanes that have failed their pipeline runs."
          example: 2
          type: integer
          readOnly: true
        fail_messages:
          type: array
          items:
            $ref: "#/components/schemas/FailureInformation"
          description: "Error information on all pipeline failures."

    FailureInformation:
      type: object
      required:
        - lane
        - stage
        - issue
      properties:
        lane:
          description: "The failed lane id."
          example: "31741_3#378"
          type: string
          readOnly: true
        stage:
          description: "The name of QC stage where issues was detected."
          example: "qc_lib"
          type: string
          readOnly: true
        issue:
          description: "The associated error message."
          example: "Error message"
          type: string
          readOnly: true

    UserData:
      type: object
      required:
        - "username"
        - "memberOf"
      properties:
        username:
          type: string
          description: "The username for this user"
          readOnly: true
        type:
          type: string
          description: "Optional employee user type field, e.g. admin"
          readOnly: true
        memberOf:
          type: array
          description: "A list of institutions and source countries of institutions for which the user is a member"
          items:
            $ref: "#/components/schemas/Institution"
